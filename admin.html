<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - NEET PG MCQs</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
      color: #0077cc;
    }
    #subjectSelect {
      margin-bottom: 15px;
      font-size: 16px;
      padding: 6px;
    }
    #questionList div {
      padding: 8px;
      background: white;
      border: 1px solid #ddd;
      margin-bottom: 6px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    #questionList div:hover {
      background-color: #e0f0ff;
    }
    form {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 0 8px #ccc;
      margin-top: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type=text], textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #aaa;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #0077cc;
      color: white;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #005fa3;
    }
    #message {
      margin-top: 10px;
      font-weight: bold;
    }
    #logoutBtn {
      float: right;
      background-color: #cc3300;
      margin-bottom: 20px;
    }
    #bulkUploadSection {
      margin-top: 30px;
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 0 8px #ccc;
    }
    #exportBtn {
      background-color: #28a745;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>NEET PG MCQ Admin Panel</h1>
  <button id="logoutBtn">Logout</button>

  <label for="subjectSelect">Select Subject:</label>
  <select id="subjectSelect">
    <option value="">-- Choose Subject --</option>
    <option value="Anatomy">Anatomy</option>
    <option value="Physiology">Physiology</option>
    <option value="Biochemistry">Biochemistry</option>
    <option value="Pathology">Pathology</option>
    <option value="Pharmacology">Pharmacology</option>
    <option value="Microbiology">Microbiology</option>
    <option value="Forensic Medicine">Forensic Medicine</option>
    <option value="Community Medicine">Community Medicine</option>
    <option value="ENT">ENT</option>
    <option value="Ophthalmology">Ophthalmology</option>
    <option value="General Medicine">General Medicine</option>
    <option value="General Surgery">General Surgery</option>
    <option value="Obstetrics & Gynaecology">Obstetrics & Gynaecology</option>
    <option value="Pediatrics">Pediatrics</option>
    <option value="Orthopaedics">Orthopaedics</option>
    <option value="Dermatology">Dermatology</option>
    <option value="Psychiatry">Psychiatry</option>
    <option value="Respiratory Medicine">Respiratory Medicine</option>
    <option value="Anesthesiology">Anesthesiology</option>
  </select>

  <div id="questionList">Select a subject to load questions.</div>

  <form id="questionForm">
    <h2 id="formTitle">Add New Question</h2>

    <label>Question Text:</label>
    <textarea id="questionText" rows="3" required></textarea>

    <label>Image URL (optional):</label>
    <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg" />

    <label>Option A:</label>
    <input type="text" id="optionA" required />

    <label>Option B:</label>
    <input type="text" id="optionB" required />

    <label>Option C:</label>
    <input type="text" id="optionC" required />

    <label>Option D:</label>
    <input type="text" id="optionD" required />

    <label>Correct Option:</label>
    <select id="correctOption" required>
      <option value="">-- Select Correct Option --</option>
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
      <option value="D">D</option>
    </select>

    <button type="submit" id="saveBtn">Save Question</button>
    <button type="button" id="resetBtn">Reset Form</button>
    <div id="message"></div>
  </form>

  <div id="bulkUploadSection">
    <h2>Bulk Upload Questions (JSON)</h2>
    <input type="file" id="jsonFileInput" accept=".json" />
    <button id="uploadJsonBtn">Upload JSON</button>
    <button id="exportBtn">Export Questions as JSON</button>
    <div id="bulkMessage"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Your Firebase config here
    const firebaseConfig = {
      apiKey: "AIzaSyDr3_9dpo55esyfpkwsAjfFi_1KMu0ZDrU",
      authDomain: "neet-88499.firebaseapp.com",
      projectId: "neet-88499",
      storageBucket: "neet-88499.firebasestorage.app",
      messagingSenderId: "889163298965",
      appId: "1:889163298965:web:fbae28b0ba478cff2f839c",
      measurementId: "G-GEG090K2JQ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const adminEmail = "y3knishu@gmail.com";

    const subjectSelect = document.getElementById("subjectSelect");
    const questionList = document.getElementById("questionList");
    const questionForm = document.getElementById("questionForm");
    const message = document.getElementById("message");
    const bulkMessage = document.getElementById("bulkMessage");

    const questionText = document.getElementById("questionText");
    const imageUrl = document.getElementById("imageUrl");
    const optionA = document.getElementById("optionA");
    const optionB = document.getElementById("optionB");
    const optionC = document.getElementById("optionC");
    const optionD = document.getElementById("optionD");
    const correctOption = document.getElementById("correctOption");
    const formTitle = document.getElementById("formTitle");
    const saveBtn = document.getElementById("saveBtn");
    const resetBtn = document.getElementById("resetBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    let editingQuestionId = null;

    // Check auth state and restrict access
    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("Please login as admin to access this page.");
        window.location.href = "login.html"; // Change to your login page
        return;
      }
      if (user.email !== adminEmail) {
        alert("Access denied. Admin only.");
        auth.signOut();
        window.location.href = "login.html";
        return;
      }
      // Admin logged in - load questions if subject selected
      if(subjectSelect.value) {
        loadQuestionsForSubject(subjectSelect.value);
      } else {
        questionList.innerHTML = "Select a subject to load questions.";
      }
    });

    // Logout button
    logoutBtn.onclick = () => {
      auth.signOut();
    };

    // Load questions for selected subject (Option C: client-side sorting)
    async function loadQuestionsForSubject(subject) {
      questionList.innerHTML = "Loading questions...";
      if (!subject) {
        questionList.innerHTML = "Select a subject to load questions.";
        return;
      }

      try {
        // Query Firestore WITHOUT orderBy to avoid composite index error
        const snapshot = await db.collection("questions")
          .where("subject", "==", subject)
          .get();

        if (snapshot.empty) {
          questionList.innerHTML = "No questions found for this subject.";
          return;
        }

        const questions = [];
        snapshot.forEach(doc => {
          questions.push({ id: doc.id, ...doc.data() });
        });

        // Sort questions client-side by question text
        questions.sort((a, b) => a.question.localeCompare(b.question));

        questionList.innerHTML = "";

        questions.forEach(data => {
          const div = document.createElement("div");
          div.textContent = data.question;
          div.dataset.id = data.id;
          div.style.cursor = "pointer";
          div.addEventListener("click", () => {
            populateFormForEdit(data.id, data);
          });
          questionList.appendChild(div);
        });
      } catch (error) {
        questionList.innerHTML = "Error loading questions: " + error.message;
      }
    }

    // When subject changes, load questions
    subjectSelect.addEventListener("change", () => {
      editingQuestionId = null;
      resetForm();
      loadQuestionsForSubject(subjectSelect.value);
    });

    // Fill form for editing
    function populateFormForEdit(id, data) {
      editingQuestionId = id;
      formTitle.textContent = "Edit Question";
      questionText.value = data.question || "";
      imageUrl.value = data.imageUrl || "";
      optionA.value = data.options?.A || "";
      optionB.value = data.options?.B || "";
      optionC.value = data.options?.C || "";
      optionD.value = data.options?.D || "";
      correctOption.value = data.correctOption || "";
      message.textContent = "";
      saveBtn.textContent = "Update Question";
    }

    // Reset form to add new question
    function resetForm() {
      editingQuestionId = null;
      formTitle.textContent = "Add New Question";
      questionForm.reset();
      message.textContent = "";
      saveBtn.textContent = "Save Question";
    }
    resetBtn.addEventListener("click", e => {
      e.preventDefault();
      resetForm();
    });

    // Save new or update existing question
    questionForm.addEventListener("submit", async e => {
      e.preventDefault();
      message.textContent = "";

      const subject = subjectSelect.value;
      if (!subject) {
        message.textContent = "Please select a subject.";
        return;
      }

      // Validate inputs
      if (
        !questionText.value.trim() ||
        !optionA.value.trim() ||
        !optionB.value.trim() ||
        !optionC.value.trim() ||
        !optionD.value.trim() ||
        !correctOption.value
      ) {
        message.textContent = "Please fill all required fields.";
        return;
      }

      const questionData = {
        subject,
        question: questionText.value.trim(),
        imageUrl: imageUrl.value.trim() || "",
        options: {
          A: optionA.value.trim(),
          B: optionB.value.trim(),
          C: optionC.value.trim(),
          D: optionD.value.trim(),
        },
        correctOption: correctOption.value,
      };

      try {
        if (editingQuestionId) {
          // Update existing
          await db.collection("questions").doc(editingQuestionId).update(questionData);
          message.style.color = "green";
          message.textContent = "Question updated successfully.";
        } else {
          // Add new
          await db.collection("questions").add(questionData);
          message.style.color = "green";
          message.textContent = "Question added successfully.";
        }
        resetForm();
        loadQuestionsForSubject(subject);
      } catch (error) {
        message.style.color = "red";
        message.textContent = "Error saving question: " + error.message;
      }
    });

    // Bulk upload JSON file
    const jsonFileInput = document.getElementById("jsonFileInput");
    const uploadJsonBtn = document.getElementById("uploadJsonBtn");
    const exportBtn = document.getElementById("exportBtn");

    uploadJsonBtn.addEventListener("click", async () => {
      bulkMessage.textContent = "";
      if (!jsonFileInput.files.length) {
        bulkMessage.style.color = "red";
        bulkMessage.textContent = "Please select a JSON file to upload.";
        return;
      }
      const file = jsonFileInput.files[0];
      const reader = new FileReader();
      reader.onload = async event => {
        try {
          const jsonData = JSON.parse(event.target.result);
          if (!Array.isArray(jsonData)) throw new Error("JSON must be an array of questions.");

          let addedCount = 0;
          for (const q of jsonData) {
            // Basic validation for required fields
            if (!q.subject || !q.question || !q.options || !q.correctOption) continue;

            await db.collection("questions").add(q);
            addedCount++;
          }

          bulkMessage.style.color = "green";
          bulkMessage.textContent = `${addedCount} questions uploaded successfully.`;
          if(subjectSelect.value) loadQuestionsForSubject(subjectSelect.value);
        } catch (err) {
          bulkMessage.style.color = "red";
          bulkMessage.textContent = "Error uploading JSON: " + err.message;
        }
      };
      reader.readAsText(file);
    });

    // Export questions as JSON file
    exportBtn.addEventListener("click", async () => {
      const subject = subjectSelect.value;
      if (!subject) {
        bulkMessage.style.color = "red";
        bulkMessage.textContent = "Please select a subject to export.";
        return;
      }

      try {
        const snapshot = await db.collection("questions")
          .where("subject", "==", subject)
          .get();

        const questions = [];
        snapshot.forEach(doc => questions.push(doc.data()));

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(questions, null, 2));
        const dlAnchor = document.createElement("a");
        dlAnchor.setAttribute("href", dataStr);
        dlAnchor.setAttribute("download", `${subject}_questions.json`);
        document.body.appendChild(dlAnchor);
        dlAnchor.click();
        dlAnchor.remove();

        bulkMessage.style.color = "green";
        bulkMessage.textContent = `Exported ${questions.length} questions for ${subject}.`;
      } catch (error) {
        bulkMessage.style.color = "red";
        bulkMessage.textContent = "Error exporting questions: " + error.message;
      }
    });
  </script>
</body>
</html>
