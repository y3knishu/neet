<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - NEET PG Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      color: #4caf50;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type=text], select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    button {
      margin-top: 15px;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    #logoutBtn {
      display: none;
      background-color: #f44336;
      color: white;
      border: none;
      float: right;
      margin-top: -40px;
      margin-bottom: 10px;
    }
    #statusMsg {
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
    #questionList {
      margin-top: 20px;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
    }
    #questionList div {
      border-bottom: 1px solid #eee;
      padding: 8px 0;
      cursor: pointer;
    }
    #questionList div:hover {
      background-color: #f0f0f0;
    }
    .form-section {
      margin-bottom: 30px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 20px;
    }
  </style>
</head>
<body>

  <h1>NEET PG Quiz Admin Panel</h1>
  <button id="logoutBtn">Logout</button>
  <div id="statusMsg"></div>

  <div class="form-section">
    <h2>Add / Edit Question</h2>
    <label for="subjectSelect">Subject</label>
    <select id="subjectSelect">
      <option value="">-- Select Subject --</option>
      <option value="Anatomy">Anatomy</option>
      <option value="Physiology">Physiology</option>
      <option value="Biochemistry">Biochemistry</option>
      <option value="Pathology">Pathology</option>
      <option value="Pharmacology">Pharmacology</option>
      <option value="Microbiology">Microbiology</option>
      <option value="Forensic Medicine">Forensic Medicine</option>
      <option value="Community Medicine">Community Medicine</option>
      <option value="ENT">ENT</option>
      <option value="Ophthalmology">Ophthalmology</option>
      <option value="General Medicine">General Medicine</option>
      <option value="General Surgery">General Surgery</option>
      <option value="Obstetrics & Gynaecology">Obstetrics & Gynaecology</option>
      <option value="Pediatrics">Pediatrics</option>
      <option value="Orthopaedics">Orthopaedics</option>
      <option value="Dermatology">Dermatology</option>
      <option value="Psychiatry">Psychiatry</option>
      <option value="Respiratory Medicine">Respiratory Medicine</option>
      <option value="Anesthesiology">Anesthesiology</option>
    </select>

    <label for="questionInput">Question</label>
    <textarea id="questionInput" rows="3" placeholder="Enter question text here"></textarea>

    <label for="imageUrlInput">Image URL (optional)</label>
    <input type="text" id="imageUrlInput" placeholder="Paste image URL here" />

    <label>Options</label>
    <input type="text" id="optionA" placeholder="Option A" />
    <input type="text" id="optionB" placeholder="Option B" />
    <input type="text" id="optionC" placeholder="Option C" />
    <input type="text" id="optionD" placeholder="Option D" />

    <label>Correct Option</label>
    <label><input type="radio" name="correctOption" value="A" /> A</label>
    <label><input type="radio" name="correctOption" value="B" /> B</label>
    <label><input type="radio" name="correctOption" value="C" /> C</label>
    <label><input type="radio" name="correctOption" value="D" /> D</label>

    <button id="saveQuestionBtn">Save Question</button>
    <button id="deleteQuestionBtn" disabled>Delete Selected Question</button>
    <button id="clearFormBtn">Clear Form</button>
  </div>

  <div class="form-section">
    <h2>Filter & View Questions</h2>
    <label for="subjectFilterSelect">Filter by Subject</label>
    <select id="subjectFilterSelect">
      <option value="">-- Select Subject --</option>
      <option value="Anatomy">Anatomy</option>
      <option value="Physiology">Physiology</option>
      <option value="Biochemistry">Biochemistry</option>
      <option value="Pathology">Pathology</option>
      <option value="Pharmacology">Pharmacology</option>
      <option value="Microbiology">Microbiology</option>
      <option value="Forensic Medicine">Forensic Medicine</option>
      <option value="Community Medicine">Community Medicine</option>
      <option value="ENT">ENT</option>
      <option value="Ophthalmology">Ophthalmology</option>
      <option value="General Medicine">General Medicine</option>
      <option value="General Surgery">General Surgery</option>
      <option value="Obstetrics & Gynaecology">Obstetrics & Gynaecology</option>
      <option value="Pediatrics">Pediatrics</option>
      <option value="Orthopaedics">Orthopaedics</option>
      <option value="Dermatology">Dermatology</option>
      <option value="Psychiatry">Psychiatry</option>
      <option value="Respiratory Medicine">Respiratory Medicine</option>
      <option value="Anesthesiology">Anesthesiology</option>
    </select>

    <div id="questionList">Select a subject to load questions.</div>
  </div>

  <div class="form-section">
    <h2>Bulk Upload Questions (JSON File)</h2>
    <input type="file" id="bulkUploadInput" accept=".json" />
    <button id="uploadJsonBtn">Upload JSON</button>
  </div>

  <div class="form-section">
    <h2>Export All Questions</h2>
    <button id="exportBtn">Export Questions as JSON</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDr3_9dpo55esyfpkwsAjfFi_1KMu0ZDrU",
      authDomain: "neet-88499.firebaseapp.com",
      projectId: "neet-88499",
      storageBucket: "neet-88499.firebasestorage.app",
      messagingSenderId: "889163298965",
      appId: "1:889163298965:web:fbae28b0ba478cff2f839c",
      measurementId: "G-GEG090K2JQ"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const allowedAdminEmail = "y3knishu@gmail.com";

    const logoutBtn = document.getElementById("logoutBtn");
    const statusMsg = document.getElementById("statusMsg");

    const subjectSelect = document.getElementById("subjectSelect");
    const questionInput = document.getElementById("questionInput");
    const imageUrlInput = document.getElementById("imageUrlInput");
    const optionA = document.getElementById("optionA");
    const optionB = document.getElementById("optionB");
    const optionC = document.getElementById("optionC");
    const optionD = document.getElementById("optionD");
    const correctOptionRadios = document.getElementsByName("correctOption");

    const saveQuestionBtn = document.getElementById("saveQuestionBtn");
    const deleteQuestionBtn = document.getElementById("deleteQuestionBtn");
    const clearFormBtn = document.getElementById("clearFormBtn");

    const subjectFilterSelect = document.getElementById("subjectFilterSelect");
    const questionList = document.getElementById("questionList");

    const bulkUploadInput = document.getElementById("bulkUploadInput");
    const uploadJsonBtn = document.getElementById("uploadJsonBtn");

    const exportBtn = document.getElementById("exportBtn");

    let currentUser = null;
    let editingQuestionId = null;

    // Auth state observer
    auth.onAuthStateChanged(user => {
      if (user) {
        if (user.email === allowedAdminEmail) {
          currentUser = user;
          statusMsg.textContent = `Logged in as admin: ${user.email}`;
          logoutBtn.style.display = "inline-block";
          loadQuestionsForSubject(subjectFilterSelect.value);
        } else {
          alert("Access denied! You are not the admin.");
          auth.signOut();
          window.location.href = "login.html";
        }
      } else {
        logoutBtn.style.display = "none";
        window.location.href = "login.html";
      }
    });

    logoutBtn.addEventListener("click", () => {
      auth.signOut();
    });

    // Load questions for selected subject
    subjectFilterSelect.addEventListener("change", () => {
      loadQuestionsForSubject(subjectFilterSelect.value);
      clearForm();
    });

    async function loadQuestionsForSubject(subject) {
      questionList.innerHTML = "Loading questions...";
      if (!subject) {
        questionList.innerHTML = "Select a subject to load questions.";
        return;
      }
      try {
        const snapshot = await db.collection("questions")
          .where("subject", "==", subject)
          .orderBy("question")
          .get();

        if (snapshot.empty) {
          questionList.innerHTML = "No questions found for this subject.";
          return;
        }

        questionList.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.textContent = data.question;
          div.dataset.id = doc.id;
          div.style.cursor = "pointer";
          div.addEventListener("click", () => {
            populateFormForEdit(doc.id, data);
          });
          questionList.appendChild(div);
        });
      } catch (error) {
        questionList.innerHTML = "Error loading questions: " + error.message;
      }
    }

    function populateFormForEdit(id, data) {
      editingQuestionId = id;
      subjectSelect.value = data.subject;
      questionInput.value = data.question;
      imageUrlInput.value = data.imageUrl || "";
      optionA.value = data.options.A || "";
      optionB.value = data.options.B || "";
      optionC.value = data.options.C || "";
      optionD.value = data.options.D || "";
      for (const radio of correctOptionRadios) {
        radio.checked = (radio.value === data.correctOption);
      }
      deleteQuestionBtn.disabled = false;
      saveQuestionBtn.textContent = "Update Question";
    }

    function clearForm() {
      editingQuestionId = null;
      subjectSelect.value = "";
      questionInput.value = "";
      imageUrlInput.value = "";
      optionA.value = "";
      optionB.value = "";
      optionC.value = "";
      optionD.value = "";
      for (const radio of correctOptionRadios) {
        radio.checked = false;
      }
      deleteQuestionBtn.disabled = true;
      saveQuestionBtn.textContent = "Save Question";
      statusMsg.textContent = "";
    }

    saveQuestionBtn.addEventListener("click", async () => {
      const subject = subjectSelect.value;
      const questionText = questionInput.value.trim();
      const imgUrl = imageUrlInput.value.trim();
      const options = {
        A: optionA.value.trim(),
        B: optionB.value.trim(),
        C: optionC.value.trim(),
        D: optionD.value.trim()
      };
      const correctOption = [...correctOptionRadios].find(r => r.checked)?.value;

      if (!subject || !questionText || !options.A || !options.B || !options.C || !options.D || !correctOption) {
        alert("Please fill all fields and select correct option.");
        return;
      }

      const questionData = {
        subject,
        question: questionText,
        imageUrl: imgUrl,
        options,
        correctOption
      };

      try {
        if (editingQuestionId) {
          await db.collection("questions").doc(editingQuestionId).set(questionData);
          statusMsg.textContent = "Question updated successfully.";
        } else {
          await db.collection("questions").add(questionData);
          statusMsg.textContent = "Question added successfully.";
        }
        clearForm();
        loadQuestionsForSubject(subjectFilterSelect.value);
      } catch (error) {
        alert("Error saving question: " + error.message);
      }
    });

    deleteQuestionBtn.addEventListener("click", async () => {
      if (!editingQuestionId) return;
      if (!confirm("Are you sure you want to delete this question?")) return;

      try {
        await db.collection("questions").doc(editingQuestionId).delete();
        statusMsg.textContent = "Question deleted successfully.";
        clearForm();
        loadQuestionsForSubject(subjectFilterSelect.value);
      } catch (error) {
        alert("Error deleting question: " + error.message);
      }
    });

    clearFormBtn.addEventListener("click", () => {
      clearForm();
    });

    uploadJsonBtn.addEventListener("click", () => {
      if (!bulkUploadInput.files.length) {
        alert("Please select a JSON file first.");
        return;
      }

      const file = bulkUploadInput.files[0];
      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const questionsArray = JSON.parse(e.target.result);
          if (!Array.isArray(questionsArray)) throw new Error("JSON must be an array.");

          let addedCount = 0;
          for (const q of questionsArray) {
            if (
              !q.subject || !q.question || !q.options ||
              !q.options.A || !q.options.B || !q.options.C || !q.options.D ||
              !q.correctOption
            ) {
              console.warn("Skipping invalid question:", q);
              continue;
            }

            await db.collection("questions").add({
              subject: q.subject,
              question: q.question,
              imageUrl: q.imageUrl || "",
              options: {
                A: q.options.A,
                B: q.options.B,
                C: q.options.C,
                D: q.options.D
              },
              correctOption: q.correctOption
            });
            addedCount++;
          }

          statusMsg.textContent = `Bulk upload complete. Added ${addedCount} questions.`;
          loadQuestionsForSubject(subjectFilterSelect.value);

        } catch (err) {
          alert("Failed to parse or upload JSON: " + err.message);
        }
      };

      reader.readAsText(file);
    });

    exportBtn.addEventListener("click", async () => {
      try {
        const snapshot = await db.collection("questions").get();
        const allQuestions = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          allQuestions.push({
            subject: data.subject,
            question: data.question,
            imageUrl: data.imageUrl || "",
            options: data.options,
            correctOption: data.correctOption
          });
        });

        const dataStr = JSON.stringify(allQuestions, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `neet_pg_questions_export_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        statusMsg.textContent = "Export completed, file downloaded.";
      } catch (error) {
        alert("Error exporting questions: " + error.message);
      }
    });
  </script>
</body>
</html>
