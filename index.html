<!-- Add this in <head> or before </body> -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<div id="subjectContainer"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // Your firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDr3_9dpo55esyfpkwsAjfFi_1KMu0ZDrU",
    authDomain: "neet-88499.firebaseapp.com",
    projectId: "neet-88499",
    storageBucket: "neet-88499.firebasestorage.app",
    messagingSenderId: "889163298965",
    appId: "1:889163298965:web:fbae28b0ba478cff2f839c",
    measurementId: "G-GEG090K2JQ"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const razorpayKey = "rzp_live_7nZptAUoDrsfRb";

  const subjects = [
    { name: "Anatomy", year: "1st Year", color: "#f44336" },
    { name: "Physiology", year: "1st Year", color: "#e91e63" },
    { name: "Biochemistry", year: "1st Year", color: "#9c27b0" },
    { name: "Pathology", year: "2nd Year", color: "#673ab7" },
    { name: "Pharmacology", year: "2nd Year", color: "#3f51b5" },
    { name: "Microbiology", year: "2nd Year", color: "#2196f3" },
    { name: "Forensic Medicine", year: "2nd Year", color: "#03a9f4" },
    { name: "Community Medicine", year: "3rd Year", color: "#00bcd4" },
    { name: "ENT", year: "3rd Year", color: "#009688" },
    { name: "Ophthalmology", year: "3rd Year", color: "#4caf50" },
    { name: "General Medicine", year: "Final Year", color: "#8bc34a" },
    { name: "General Surgery", year: "Final Year", color: "#cddc39" },
    { name: "Obstetrics & Gynaecology", year: "Final Year", color: "#ffeb3b" },
    { name: "Pediatrics", year: "Final Year", color: "#ffc107" },
    { name: "Orthopaedics", year: "Final Year", color: "#ff9800" },
    { name: "Dermatology", year: "Final Year", color: "#ff5722" },
    { name: "Psychiatry", year: "Final Year", color: "#795548" },
    { name: "Respiratory Medicine", year: "Final Year", color: "#9e9e9e" },
    { name: "Anesthesiology", year: "Final Year", color: "#607d8b" }
  ];

  const subjectContainer = document.getElementById("subjectContainer");

  function createSubjectCard(subject, unlocked) {
    const card = document.createElement("div");
    card.style.backgroundColor = subject.color;
    card.style.color = "#fff";
    card.style.padding = "20px";
    card.style.margin = "10px";
    card.style.borderRadius = "12px";
    card.style.width = "220px";
    card.style.display = "inline-block";
    card.style.position = "relative";
    card.style.textAlign = "center";
    card.style.cursor = unlocked ? "pointer" : "default";

    card.innerHTML = `<h3>${subject.name}</h3><small>${subject.year}</small>`;

    if (!unlocked) {
      // Lock overlay and pay button
      const lockOverlay = document.createElement("div");
      lockOverlay.style.position = "absolute";
      lockOverlay.style.top = 0;
      lockOverlay.style.left = 0;
      lockOverlay.style.width = "100%";
      lockOverlay.style.height = "100%";
      lockOverlay.style.background = "rgba(0,0,0,0.6)";
      lockOverlay.style.borderRadius = "12px";
      lockOverlay.style.display = "flex";
      lockOverlay.style.flexDirection = "column";
      lockOverlay.style.justifyContent = "center";
      lockOverlay.style.alignItems = "center";
      lockOverlay.style.color = "white";

      const lockIcon = document.createElement("div");
      lockIcon.innerHTML = "ðŸ”’";
      lockIcon.style.fontSize = "36px";
      lockOverlay.appendChild(lockIcon);

      const payBtn = document.createElement("button");
      payBtn.textContent = "Pay â‚¹99 to Unlock";
      payBtn.style.marginTop = "12px";
      payBtn.style.padding = "8px 12px";
      payBtn.style.border = "none";
      payBtn.style.borderRadius = "6px";
      payBtn.style.backgroundColor = "#f44336";
      payBtn.style.color = "#fff";
      payBtn.style.cursor = "pointer";

      payBtn.onclick = () => openRazorpayCheckout();

      lockOverlay.appendChild(payBtn);
      card.appendChild(lockOverlay);
    } else {
      card.onclick = () => {
        // Redirect to quiz page with subject param
        window.location.href = `quiz.html?subject=${encodeURIComponent(subject.name)}`;
      };
    }

    return card;
  }

  function renderSubjects(isPaid) {
    subjectContainer.innerHTML = "";

    // Group by year
    const years = [...new Set(subjects.map(s => s.year))];

    years.forEach(year => {
      const yearHeader = document.createElement("h2");
      yearHeader.textContent = year;
      subjectContainer.appendChild(yearHeader);

      const yearSubjects = subjects.filter(s => s.year === year);

      yearSubjects.forEach(subject => {
        const unlocked = subject.name === "Anatomy" || isPaid;
        const card = createSubjectCard(subject, unlocked);
        subjectContainer.appendChild(card);
      });
    });
  }

  function openRazorpayCheckout() {
    const user = auth.currentUser;
    if (!user) {
      alert("Please login to pay.");
      return;
    }

    const options = {
      key: razorpayKey,
      amount: 9900, // â‚¹99 in paise
      currency: "INR",
      name: "NEET PG Quiz",
      description: "Unlock all subjects except Anatomy",
      handler: function (response) {
        alert("Payment successful! Payment ID: " + response.razorpay_payment_id);
        // Update Firestore user document isPaid flag
        db.collection('users').doc(user.uid).set({ isPaid: true }, { merge: true })
          .then(() => {
            renderSubjects(true);
          })
          .catch(err => alert("Failed to update payment status: " + err.message));
      },
      prefill: {
        email: user.email,
      },
      theme: {
        color: "#344ea3"
      }
    };
    const rzp = new Razorpay(options);
    rzp.open();
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      db.collection('users').doc(user.uid).get()
        .then(doc => {
          const isPaid = doc.exists && doc.data().isPaid;
          renderSubjects(isPaid);
        })
        .catch(() => renderSubjects(false));
    } else {
      renderSubjects(false);
    }
  });
</script>
